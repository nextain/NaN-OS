# UI E2E 72/72 RPC 커버리지 — 작업 핸드오프 문서

## 날짜
- 시작: 2026-02-19
- 현재: 2026-02-20
- 상태: **코드 작성 완료, E2E 실행 + 디버깅 필요**

## 프로젝트
`cafelua-os` — Shell E2E (Tauri WebdriverIO)

---

## 완료된 작업

### 커밋 내역
| 커밋 | 내용 |
|------|------|
| `2e32683` | docs: 계획 문서 (`work-logs/20260219-04-ui-e2e-openclaw-100-coverage.md`) |
| `eec2a70` | **test(shell): UI E2E 72/72 전체 구현** — 26개 파일, +1568/-182줄 |

### 구현 완료 목록

#### 1. selectors.ts 수정
- **파일**: `shell/e2e-tauri/helpers/selectors.ts`
- `settingsTabBtn`: `.chat-tab:nth-child(7)` → `.chat-tab:nth-child(8)` (DiagnosticsTab이 7번째로 추가됨)
- 신규 셀렉터 추가: `diagnosticsTabBtn`, `diagnosticsTabPanel`, `diagnosticsStatusGrid`, `diagnosticsStatusItem`, `diagnosticsStatusOk`, `diagnosticsStatusErr`, `diagnosticsRefreshBtn`, `diagnosticsLogBtn`, `diagnosticsLogsContainer`, `agentFilesBtn`, `agentFileItem`, `agentFileTextarea`, `agentFileSaveBtn`, `sessionCompactBtn`, `sessionDeleteBtn`, `deviceNodeCard`, `deviceNodesList`, `devicePairRequests`, `devicePairApprove`, `devicePairReject`

#### 2. Stub Spec 재작성 (4개)
| Spec | 변경 | 커버 RPC |
|------|------|---------|
| `29-cron-gateway.spec.ts` | sendMessage + waitForToolSuccess + 크론 텍스트 검증 | `cron.list` |
| `30-exec-approvals.spec.ts` | skill_approvals get_rules + autoApprovePermissions | `exec.approvals.get` |
| `31-diagnostics.spec.ts` | DiagnosticsTab UI 직접 테스트 (상태 그리드, 새로고침, 로그 버튼) | `status`, `logs.tail` |
| `34-device-pairing.spec.ts` | Settings DevicePairingSection UI (노드 목록, 페어 요청) | `node.list`, `node.pair.list` |

#### 3. Partial Spec 강화 (5개)
| Spec | 변경 | 커버 RPC |
|------|------|---------|
| `23-channels-status.spec.ts` | 로딩 대기 + 카드/배지 검증 + 새로고침 | `channels.status` |
| `24-tts-providers.spec.ts` | 옵션 개수/값 검증 | `tts.providers` |
| `26-sessions-management.spec.ts` | 세션 카드 메타데이터 + compact/delete 버튼 | `sessions.list`, `sessions.delete`, `sessions.compact` |
| `27-multi-agent.spec.ts` | 에이전트 이름 + 파일 관리 (files.list, files.get) | `agents.list`, `agents.files.list`, `agents.files.get` |
| `28-skills-install.spec.ts` | 게이트웨이 스킬 카드 텍스트 + install 버튼 상태 | `skills.status` |

#### 4. 신규 Spec (16개)
| Spec | 커버 RPC | 테스트 방식 |
|------|---------|-----------|
| `37-execute-command.spec.ts` | `exec.bash` | 채팅: echo 실행 |
| `38-file-operations.spec.ts` | `exec.bash` (read/write/search/diff) | 채팅: 파일 CRUD 체인 |
| `39-web-tools.spec.ts` | `skills.invoke`, `browser.request` | 채팅: browser, web_search |
| `40-sessions-spawn.spec.ts` | `sessions.spawn`, `agent.wait`, `sessions.transcript` | 채팅: 서브에이전트 생성 |
| `41-agents-crud.spec.ts` | `agents.create/update/delete`, `agents.files.set` | 채팅: 에이전트 수명주기 |
| `42-sessions-crud.spec.ts` | `sessions.preview/patch/reset` | 채팅: 세션 관리 |
| `43-device-management.spec.ts` | `node.describe/rename`, `node.pair.*`, `device.pair.*`, `device.token.*`, `node.invoke` | 채팅: 대부분 error path |
| `44-diagnostics-full.spec.ts` | `health`, `usage.status`, `usage.cost` | 채팅: skill_diagnostics |
| `45-cron-gateway-full.spec.ts` | `cron.status/add/runs/run/remove` | 채팅: skill_cron gateway_* |
| `46-channels-operations.spec.ts` | `channels.logout`, `web.login.start/wait` | 채팅: error path |
| `47-tts-full.spec.ts` | `tts.status/enable/setProvider/convert/disable` | 채팅: skill_tts 전체 |
| `48-voicewake-set.spec.ts` | `voicewake.set` | 채팅: skill_voicewake |
| `49-approvals-full.spec.ts` | `exec.approvals.set/resolve` | 채팅: skill_approvals |
| `50-config-management.spec.ts` | `config.get/set/schema/patch`, `models.list` | 채팅: skill_config |
| `51-skills-advanced.spec.ts` | `skills.status/bins/install/update` | 채팅: skill_skill_manager |
| `52-wizard-rpc.spec.ts` | `wizard.start/next/cancel/status` | 채팅: LLM에 직접 요청 |

#### 5. TypeScript 검증
- **내 파일 에러: 0개**
- 기존 pre-existing 에러 3개 (spec 14, 36, 99 — 이번 작업 범위 밖)

---

## 남은 작업 (TODO)

### 1. E2E 실행 + 디버깅 (핵심)
```bash
# 사전 확인
lsof -ti:18789  # Gateway 실행 중인지 확인 (ws://localhost:18789)
ls -la shell/src-tauri/target/debug/cafelua-shell  # Tauri 바이너리 존재 확인

# 전체 실행
cd cafelua-os/shell && pnpm run test:e2e:tauri

# 특정 spec만 디버깅
cd cafelua-os/shell && pnpm exec wdio run e2e-tauri/wdio.conf.ts --spec e2e-tauri/specs/37-execute-command.spec.ts
```

### 2. 실패 Spec 수정
- 채팅 기반 테스트 (37-52)는 **LLM이 지시한 도구를 사용하지 않을 수 있음**
  - 프롬프트 조정 필요할 수 있음 (더 명시적으로 도구명+액션명 지정)
  - `waitForToolSuccess()` 타임아웃 시 best-effort로 전환 검토
- UI 탭 테스트 (23, 26, 27, 28, 31, 34)는 **셀렉터가 실제 DOM과 불일치**할 수 있음
  - 실행 후 실패 메시지 기반으로 셀렉터 수정

### 3. 알려진 리스크
| 리스크 | 대응 |
|--------|------|
| spec 52 (wizard): `skill_wizard` 없어 LLM이 RPC 호출 불가 | agent에 `skill_wizard` 추가하거나, 52를 best-effort으로 전환 |
| spec 43 (device): 페어링된 노드 없으면 대부분 error path | error path 테스트가 목적이므로 OK |
| spec 40 (sessions_spawn): Gateway가 spawn 미지원 시 실패 | best-effort 전환 |
| spec 46 (channels): QR 로그인 자동화 불가 | error path 테스트가 목적이므로 OK |
| `autoApprovePermissions()` 타이밍: 권한 모달이 나타나기 전에 도구 실행 시도 | polling 간격(500ms) 충분한지 확인 |

### 4. 최종 커밋 + 푸시
- E2E 전체 통과 후 최종 커밋
- work-log 업데이트 (통과 결과 기록)

---

## 파일 구조 참조

```
cafelua-os/shell/e2e-tauri/
├── helpers/
│   ├── selectors.ts    # CSS 셀렉터 상수 (S) ← 수정됨
│   ├── chat.ts         # sendMessage, getLastAssistantMessage, waitForToolSuccess
│   ├── settings.ts     # configureSettings
│   └── permissions.ts  # autoApprovePermissions
├── specs/
│   ├── 01-36, 99       # 기존 spec (01-22, 25, 32-33, 35-36, 99 변경 없음)
│   ├── 23, 24, 26-31, 34  # 수정된 spec (강화/재작성)
│   └── 37-52           # 신규 spec (16개)
└── wdio.conf.ts        # WebdriverIO 설정
```

## 72/72 RPC 매핑 요약

상세 매트릭스는 `work-logs/20260219-04-ui-e2e-openclaw-100-coverage.md`의 "72/72 RPC 전수 체크 매트릭스" 섹션 참조.

## 실행 환경 요구사항
- Gateway: `~/.cafelua/openclaw/node_modules/.bin/openclaw gateway run --bind loopback --port 18789`
- Tauri 바이너리: `shell/src-tauri/target/debug/cafelua-shell`
- API 키: `shell/.env` (GEMINI_API_KEY 등)
- Node.js 환경 + pnpm
