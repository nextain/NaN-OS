description: Implementation plan (token-optimized mirror of .users/context/plan.md)

strategy: "Deploy first, add features incrementally. Every push = new ISO."

phases:
  phase_0:
    name: "Deploy pipeline"
    timeline: "Day 1-3"
    deliverable: "GitHub push → BlueBuild → ghcr.io image → ISO (GitHub Releases)"
    tasks:
      - "os/recipe.yml (BlueBuild recipe, base: bazzite)"
      - ".github/workflows/build.yml (GitHub Actions)"
      - "ISO generation (ublue-os/isogenerator)"
    done_when: "USB boot = Bazzite + Node.js (no custom yet)"

  phase_1:
    name: "Avatar on screen"
    timeline: "Week 1"
    deliverable: "Boot → Alpha VRM avatar auto-starts on screen"
    stack: "Tauri 2, React 18+/TypeScript/Vite, Three.js r0.182, @pixiv/three-vrm ^3.4.5, shadcn/ui, Zustand, Biome"
    tasks:
      step_1_init:
        name: "Tauri 2 + React project init"
        items:
          - "React + TS + Vite in shell/"
          - "Biome config (tab, double quote, semicolons)"
          - "shadcn/ui, Three.js, @pixiv/three-vrm, zustand install"
          - "Tauri 2 backend (Cargo.toml, tauri.conf.json, main.rs, lib.rs)"
      step_2_vrm_core:
        name: "AIRI VRM core extraction"
        copy_as_is:
          - { from: "stage-ui-three/composables/vrm/core.ts", to: "src/lib/vrm/core.ts" }
          - { from: "stage-ui-three/composables/vrm/loader.ts", to: "src/lib/vrm/loader.ts" }
          - { from: "stage-ui-three/composables/vrm/utils/eye-motions.ts", to: "src/lib/vrm/eye-motions.ts" }
          - { from: "stage-ui-three/assets/vrm/animations/idle_loop.vrma", to: "public/animations/idle_loop.vrma" }
        extract_pure_functions:
          - "loadVRMAnimation, clipFromVRMAnimation, reAnchorRootPositionTrack → src/lib/vrm/animation.ts"
      step_3_react_hooks:
        name: "Vue → React hooks porting"
        items:
          - "useBlink.ts — Vue ref() → useRef, blink timing logic"
          - "useIdleEyes.ts — Vue ref() → useRef, saccade logic"
      step_4_avatar_canvas:
        name: "AvatarCanvas component"
        items:
          - "Three.js WebGLRenderer + Scene + Camera setup"
          - "VRM loading via core.ts"
          - "idle animation playback"
          - "Render loop order: animation → humanoid → lookAt → blink → saccade → expression → springBone"
      step_5_tauri_window:
        name: "Tauri window config"
        items:
          - "Default window (transparent/borderless = Phase 2)"
          - "App icon, title: Cafelua Shell"
      step_6_integration:
        name: "Integration test"
        items:
          - "pnpm tauri dev → avatar visible with idle animation"
    done_when: "USB boot → Alpha avatar visible with idle animation + blink + saccade"
    reuse: "AIRI: Three.js + @pixiv/three-vrm (stage-ui-three)"

  phase_2:
    name: "Chat with Alpha"
    timeline: "Week 2"
    deliverable: "Text chat with Alpha, avatar lip-sync + emotions"
    llm_providers: "xAI (Grok), Google (Gemini), Anthropic (Claude) — see project-careti providers for reference"
    default_provider: "Google (Gemini) — primary for chat/TTS/vision; Claude for coding tasks"
    compatibility:
      aaif: "AAIF standard (Agentic AI Foundation, Linux Foundation 2025.12)"
      pillars:
        - "AGENTS.md (context layer, OpenAI donated)"
        - "SKILL.md (execution layer, procedural knowledge)"
        - "MCP (connectivity layer, Anthropic donated)"
      claude_code: "Full compatibility — CLAUDE.md, .claude/ ↔ .agents/ interoperable"
      careti_context: "Agent must consume project-careti .agents/ context as-is"
      reference: "project-careti F06 (careti-docs/features.en/f06-agent-standard-claude-compat.md)"
    cost_tracking: "Per-request cost display (project-careti provider pattern)"
    tasks:
      - "Agent core: LLM providers (xAI/Google/Claude), stdio protocol"
      - "AAIF context consumption (.agents/ + AGENTS.md hierarchy)"
      - "Tauri stdio bridge (spawn agent-core as child process)"
      - "Chat panel UI + streaming response + cost display"
      - "Avatar emotion mapping + lip-sync (Google TTS)"
      - "Onboarding: API key setup on first boot (support xAI, Google, Claude keys)"
    done_when: "USB boot → API key → chat with Alpha (lip-sync + emotions + cost visible)"
    reuse: "Careti: stdio-adapter.ts, lib.rs, LLM providers (xAI/Google/Claude), F06 context system"
    public_demo: true

  phase_3:
    name: "Alpha does work"
    timeline: "Week 3-4"
    deliverable: "Alpha can edit files, run terminal commands, search web"
    tasks:
      - "Tool system: file_read ✅, file_write ✅, apply_diff ✅, execute_command ✅, browser ✅, search ✅, web_search ✅"
      - "Permission tiers (0-3) + approval UI ✅"
      - "Audit log (SQLite) ✅"
      - "Work progress panel ✅"
      - "Sub-agents ✅ (sequential + parallel spawn via Gateway RPC)"
    status: "complete"
    done_when: "Alpha executes real OS tasks with permission system"
    reuse: "Careti: tools, SmartEditEngine, sub-agent pattern"

  phase_4:
    name: "Always-on daemon"
    timeline: "Week 5-7"
    deliverable: "Gateway daemon + external channels + memory"
    status: "in_progress"
    strategy: "Gateway first → Phase 3 runtime verification → then new features"
    tasks:
      step_4_0:
        name: "OpenClaw Gateway local setup"
        description: "Get Gateway running locally to unlock Phase 3 runtime verification"
        status: "complete"
        items:
          - "OpenClaw install + config (setup-openclaw.sh already exists) ✅"
          - "Gateway local start (cafelua-gateway-wrapper) ✅"
          - "Shell → Agent → Gateway WebSocket connection verified ✅"
          - "Gateway auto-lifecycle in Tauri (spawn/health/shutdown) ✅"
        done_when: "gateway_health() returns true, Agent connects via WebSocket"
      step_4_0_lifecycle:
        name: "Gateway auto-lifecycle"
        description: "Tauri app manages Gateway process automatically"
        status: "complete"
        items:
          - "GatewayProcess struct + AppState integration ✅"
          - "Hybrid strategy: reuse if running, spawn if not ✅"
          - "Node.js 22+ detection with nvm fallback ✅"
          - "Health check polling (5s timeout, 500ms interval) ✅"
          - "Graceful shutdown: only kill self-spawned Gateway ✅"
          - "gateway_status event emit to frontend ✅"
      step_4_1:
        name: "Phase 3 E2E verification"
        description: "Verify all Phase 3 tools work through live Gateway"
        status: "complete"
        items:
          - "8 tools runtime test (read/write/diff/command/search/web_search/browser/spawn) ✅"
          - "Permission approval flow (Tier 1-2 modal actual UI) ✅"
          - "Sub-agent parallel execution real verification ✅"
          - "Audit log actual recording check ✅"
          - "Fix bugs discovered during runtime testing ✅"
        done_when: "All 8 tools execute successfully through Gateway"
      step_4_2:
        name: "User testing (manual)"
        description: "Manual end-to-end testing via pnpm tauri dev"
        items:
          - "Chat → tool invocation → result display"
          - "File read/write/edit scenarios"
          - "Command execution scenarios"
          - "Error cases (permission reject, timeout)"
        done_when: "User confirms Phase 3 tools work correctly"
      step_4_3:
        name: "Skills system"
        items:
          - "Skill registry + matching"
          - "Built-in skills (weather, memo, system status)"
          - "Custom skill loader (~/.cafelua/skills/)"
      step_4_4:
        name: "Memory persistence"
        items:
          - "SQLite conversation storage"
          - "Vector search (embeddings)"
          - "Context recall on relevant queries"
      step_4_5:
        name: "External channels"
        items:
          - "Discord bot (discord.js)"
          - "Telegram bot (grammY)"
          - "External channels limited to Tier 0-1"
      step_4_6:
        name: "systemd auto-start integration"
        items:
          - "Gateway auto-start on boot"
          - "Health monitoring"
    done_when: "OS boot → auto-start → external channel access → remembers context"
    reuse: "MoltBot: Gateway pattern, channel SDKs, Skills"

  phase_5:
    name: "Gaming with Alpha"
    timeline: "Week 8+"
    deliverable: "Co-play Minecraft, game overlay avatar"
    tasks:
      - "Minecraft agent (Mineflayer, autonomous actions)"
      - "Generic game support (screen capture + vision model)"
      - "Game overlay avatar + voice chat"
    done_when: "Alpha joins Minecraft and plays autonomously"
    reuse: "AIRI: services/minecraft/, Mineflayer"

attention_points:
  phase_0: "Deploy pipeline = highest priority. Everything else layers on top."
  phase_2: "Public demo point. Must be polished enough to share."
  security: "Permission tiers active from Phase 3. Audit log from day one."
